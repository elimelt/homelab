services:
  tailscale:
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    container_name: tailscale
    restart: always
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=${TAILSCALE_EXTRA_ARGS:-}
      - TS_HOSTNAME=${TAILSCALE_HOSTNAME:-devstack}
    volumes:
      - ${TAILSCALE_STATE_DIR:-./tailscale/state}:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: "service:traefik"
    depends_on:
      - traefik
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1

  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: always
    command:
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--providers.file.filename=/traefik-config.yml"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
      - "--accesslog.fields.names.ClientUsername=keep"
      - "--accesslog.fields.headers.names.User-Agent=keep"
      - "--accesslog.fields.headers.names.X-Forwarded-For=keep"
      - "--log.level=INFO"
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-8443}:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${TRAEFIK_CERTS_PATH:-./certs}:/certs:ro
      - ${TRAEFIK_CONFIG_PATH:-./traefik-config.yml}:/traefik-config.yml:ro
      - ${TRAEFIK_LOGS_PATH:-./logs}:/var/log/traefik
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-api.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/dashboard`)"
      - "traefik.http.routers.traefik-api.entrypoints=websecure"
      - "traefik.http.routers.traefik-api.tls=true"
      - "traefik.http.routers.traefik-api.service=api@internal"
      - "traefik.http.routers.traefik-api.middlewares=auth"
      - "traefik.http.routers.traefik-api.priority=10"
      - "traefik.http.middlewares.auth.basicauth.users=${BASIC_AUTH_USERS}"

  postgres:
    image: pgvector/pgvector:pg16
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-devuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-devdb}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - dev_network

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: redis
    restart: always
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --save 900 1 --save 300 10 --save 60 10000
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
      --maxclients 10000
      --slowlog-log-slower-than 10000
      --slowlog-max-len 128
    volumes:
      - redis_data:/data
    networks:
      - dev_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

  grafana:
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    container_name: grafana
    restart: always
    environment:
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SERVER_ROOT_URL=https://${DOMAIN}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ${GRAFANA_PROVISIONING_PATH:-./grafana}:/etc/grafana/provisioning
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.http.routers.grafana.middlewares=auth"
      - "traefik.http.routers.grafana.priority=10"

  prometheus:
    image: prom/prometheus:${PROMETHEUS_VERSION:-latest}
    container_name: prometheus
    restart: always
    volumes:
      - ${PROMETHEUS_CONFIG_PATH:-./prometheus.yml}:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.external-url=https://${DOMAIN}/prometheus'
      - '--web.route-prefix=/'
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/prometheus`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
      - "traefik.http.routers.prometheus.middlewares=auth,prometheus-strip"
      - "traefik.http.routers.prometheus.priority=10"
      - "traefik.http.middlewares.prometheus-strip.stripprefix.prefixes=/prometheus"

  loki:
    image: grafana/loki:${LOKI_VERSION:-latest}
    container_name: loki
    restart: always
    volumes:
      - ${LOKI_CONFIG_PATH:-./loki-config.yml}:/etc/loki/config.yml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/config.yml
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loki.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/loki`)"
      - "traefik.http.routers.loki.entrypoints=websecure"
      - "traefik.http.routers.loki.tls=true"
      - "traefik.http.services.loki.loadbalancer.server.port=3100"
      - "traefik.http.routers.loki.middlewares=auth"
      - "traefik.http.routers.loki.priority=10"

  promtail:
    image: grafana/promtail:${PROMTAIL_VERSION:-latest}
    container_name: promtail
    restart: always
    volumes:
      - ${PROMTAIL_CONFIG_PATH:-./promtail-config.yml}:/etc/promtail/promtail-config.yml
      - ${TRAEFIK_LOGS_PATH:-./logs}:/var/log/traefik:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/promtail-config.yml
    networks:
      - dev_network

  node-exporter:
    image: prom/node-exporter:${NODE_EXPORTER_VERSION:-latest}
    container_name: node-exporter
    restart: always
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - dev_network

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:${CADVISOR_VERSION:-latest}
    container_name: cadvisor
    restart: always
    command:
      - '--docker_only=true'
      - '--housekeeping_interval=30s'
      - '--disable_metrics=disk,diskIO,percpu'
      - '--store_container_labels=false'
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg
    networks:
      - dev_network

  homepage:
    image: nginx:${NGINX_VERSION:-alpine}
    container_name: homepage
    restart: always
    volumes:
      - ${HOMEPAGE_PATH:-./homepage}:/usr/share/nginx/html:ro
      - ${HOMEPAGE_PATH:-./homepage}/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - internal-api
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.services.homepage.loadbalancer.server.port=80"
      - "traefik.http.services.homepage.loadbalancer.responseforwarding.flushinterval=1ms"
      - "traefik.http.routers.homepage.middlewares=auth"
      - "traefik.http.routers.homepage.priority=1"

  public-api:
    build: ${API_PATH:-./api}
    container_name: public-api
    restart: always
    user: root
    ports:
      - "127.0.0.1:10000:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - API_ROOT_PATH=/api
      - CORS_ORIGINS=${API_CORS_ORIGINS:-http://localhost:3000,https://elimelt.com}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-200}
      - REDIS_POOL_TIMEOUT_SEC=${REDIS_POOL_TIMEOUT_SEC:-5}
      - REDIS_DEBUG=${REDIS_DEBUG:-0}
      - REQUEST_DEBUG=${REQUEST_DEBUG:-0}
      - WS_DEBUG=${WS_DEBUG:-0}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ENABLE_CHAT_DB=1
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-devuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-devdb}
      - NOTES_SYNC_SECRET=${NOTES_SYNC_SECRET:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
    depends_on:
      - redis
      - postgres
    networks:
      - dev_network

  internal-api:
    build:
      context: ${API_PATH:-./api}
      dockerfile: Dockerfile.internal
    container_name: internal-api
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - AUGMENT_API_TOKEN=${AUGMENT_API_TOKEN}
      - AUGMENT_SESSION_AUTH=${AUGMENT_API_TOKEN}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - AGENTS=${AGENTS:-5}
      - AGENT_MIN_SLEEP_SEC=${AGENT_MIN_SLEEP_SEC:-30}
      - AGENT_MAX_SLEEP_SEC=${AGENT_MAX_SLEEP_SEC:-120}
      - AGENT_WAKE_PROB=${AGENT_WAKE_PROB:-0.2}
      - AGENT_WAKE_COOLDOWN_SEC=${AGENT_WAKE_COOLDOWN_SEC:-45}
      - AGENT_DEBUG=${AGENT_DEBUG:-0}
      - AGENT_LOG_LEVEL=${AGENT_LOG_LEVEL:-INFO}
      - ENABLE_GEMINI_AGENT=${ENABLE_GEMINI_AGENT:-1}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-50}
      - ENABLE_CHAT_DB=1
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-devuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-devdb}
      - NOTES_SYNC_SECRET=${NOTES_SYNC_SECRET:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - SANDBOX_ENABLED=${SANDBOX_ENABLED:-1}
      - SANDBOX_IMAGE=devstack-python-sandbox:latest
      - SANDBOX_TIMEOUT_SEC=${SANDBOX_TIMEOUT_SEC:-30}
      - SANDBOX_MEMORY_LIMIT=${SANDBOX_MEMORY_LIMIT:-128m}
    depends_on:
      - redis
      - postgres
      - python-sandbox
    networks:
      - dev_network

  python-sandbox:
    build:
      context: ${API_PATH:-./api}/sandbox
      dockerfile: Dockerfile
    image: devstack-python-sandbox:latest
    container_name: python-sandbox-builder
    entrypoint: ["echo", "Sandbox image built successfully"]

  uptime-kuma:
    image: louislam/uptime-kuma:${UPTIME_KUMA_VERSION:-2}
    container_name: uptime-kuma
    restart: always
    volumes:
      - uptime_kuma_data:/app/data
    environment:
      # Allow embedding in iframes (for dashboards like Homepage)
      - UPTIME_KUMA_DISABLE_FRAME_SAMEORIGIN=true
    networks:
      - dev_network
    labels:
      - "traefik.enable=false"

  funnel-proxy:
    image: nginx:alpine
    container_name: funnel-proxy
    restart: always
    ports:
      - "443:80"
    volumes:
      - ./funnel-proxy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - uptime-kuma
      - public-api
    networks:
      - dev_network

  minecraft:
    image: itzg/minecraft-server:${MINECRAFT_VERSION:-latest}
    container_name: minecraft
    restart: always
    ports:
      - "${MINECRAFT_PORT:-25565}:25565"
    environment:
      # Server type and version
      - TYPE=${MINECRAFT_TYPE:-PAPER}
      - VERSION=${MINECRAFT_GAME_VERSION:-LATEST}
      - EULA=TRUE

      # Memory allocation - 6GB for 10+ players with good performance
      - MEMORY=${MINECRAFT_MEMORY:-6G}
      - INIT_MEMORY=${MINECRAFT_INIT_MEMORY:-4G}
      - MAX_MEMORY=${MINECRAFT_MAX_MEMORY:-6G}

      # JVM optimization flags for production
      - JVM_XX_OPTS=-XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1

      # Server properties
      - SERVER_NAME=${MINECRAFT_SERVER_NAME:-Homelab Minecraft}
      - MOTD=${MINECRAFT_MOTD:-Welcome to the Homelab Minecraft Server!}
      - DIFFICULTY=${MINECRAFT_DIFFICULTY:-normal}
      - MODE=${MINECRAFT_GAMEMODE:-survival}
      - MAX_PLAYERS=${MINECRAFT_MAX_PLAYERS:-20}
      - VIEW_DISTANCE=${MINECRAFT_VIEW_DISTANCE:-12}
      - SIMULATION_DISTANCE=${MINECRAFT_SIMULATION_DISTANCE:-10}
      - SPAWN_PROTECTION=${MINECRAFT_SPAWN_PROTECTION:-0}
      - ALLOW_NETHER=true
      - ENABLE_COMMAND_BLOCK=true
      - MAX_TICK_TIME=60000
      - NETWORK_COMPRESSION_THRESHOLD=256

      # Security and ops
      - OPS=${MINECRAFT_OPS:-}
      - WHITELIST=${MINECRAFT_WHITELIST:-}
      - ENFORCE_WHITELIST=${MINECRAFT_ENFORCE_WHITELIST:-false}
      - ONLINE_MODE=${MINECRAFT_ONLINE_MODE:-true}
      - ENABLE_RCON=${MINECRAFT_ENABLE_RCON:-true}
      - RCON_PASSWORD=${MINECRAFT_RCON_PASSWORD:-}
      - RCON_PORT=25575

      # World settings
      - LEVEL=${MINECRAFT_LEVEL:-world}
      - SEED=${MINECRAFT_SEED:-}
      - GENERATE_STRUCTURES=true
      - MAX_WORLD_SIZE=29999984

      # Performance tuning
      - USE_AIKAR_FLAGS=true
      - ENABLE_AUTOPAUSE=${MINECRAFT_AUTOPAUSE:-false}
      - AUTOPAUSE_TIMEOUT_EST=${MINECRAFT_AUTOPAUSE_TIMEOUT:-3600}
      - AUTOPAUSE_TIMEOUT_INIT=${MINECRAFT_AUTOPAUSE_INIT:-600}

      # Timezone
      - TZ=${TZ:-America/Los_Angeles}
    volumes:
      - minecraft_data:/data
    networks:
      - dev_network
    # Resource limits for production stability
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    healthcheck:
      test: mc-health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    stdin_open: true
    tty: true

volumes:
  postgres_data:
  redis_data:
  grafana_data:
  prometheus_data:
  loki_data:
  uptime_kuma_data:
  minecraft_data:


networks:
  dev_network:
    driver: bridge

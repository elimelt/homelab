services:
  tailscale:
    image: tailscale/tailscale:${TAILSCALE_VERSION:-latest}
    container_name: tailscale
    restart: always
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_EXTRA_ARGS=${TAILSCALE_EXTRA_ARGS:-}
      - TS_HOSTNAME=${TAILSCALE_HOSTNAME:-devstack}
    volumes:
      - ${TAILSCALE_STATE_DIR:-./tailscale/state}:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: "service:traefik"
    depends_on:
      - traefik
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1

  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: always
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--providers.file.filename=/traefik-config.yml"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addRoutersLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--accesslog.format=json"
      - "--accesslog.fields.names.ClientUsername=keep"
      - "--accesslog.fields.headers.names.User-Agent=keep"
      - "--accesslog.fields.headers.names.X-Forwarded-For=keep"
      - "--log.level=INFO"
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${TRAEFIK_CERTS_PATH:-./certs}:/certs:ro
      - ${TRAEFIK_CONFIG_PATH:-./traefik-config.yml}:/traefik-config.yml:ro
      - ${TRAEFIK_LOGS_PATH:-./logs}:/var/log/traefik
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-api.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.traefik-api.entrypoints=websecure"
      - "traefik.http.routers.traefik-api.tls=true"
      - "traefik.http.routers.traefik-api.service=api@internal"
      - "traefik.http.routers.traefik-api.middlewares=auth"
      - "traefik.http.routers.traefik-api.priority=10"
      - "traefik.http.middlewares.auth.basicauth.users=${BASIC_AUTH_USERS}"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/portainer`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
      - "traefik.http.routers.portainer.middlewares=auth,portainer-strip"
      - "traefik.http.routers.portainer.priority=10"
      - "traefik.http.middlewares.portainer-strip.stripprefix.prefixes=/portainer"

  code-server:
    image: lscr.io/linuxserver/code-server:latest
    container_name: code-server
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - PASSWORD=
      - SUDO_PASSWORD=${CODE_SERVER_SUDO_PASSWORD}
      - PROXY_DOMAIN=${DOMAIN}/code
      - DEFAULT_WORKSPACE=/config/workspace
    volumes:
      - ${CODE_SERVER_CONFIG_PATH:-./code-server/config}:/config
      - ${CODE_SERVER_WORKSPACE_PATH:-~/repos}:/config/workspace
    restart: unless-stopped
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.code.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/code`)"
      - "traefik.http.routers.code.entrypoints=websecure"
      - "traefik.http.routers.code.tls=true"
      - "traefik.http.services.code.loadbalancer.server.port=8443"
      - "traefik.http.routers.code.middlewares=auth,code-headers,code-strip"
      - "traefik.http.routers.code.priority=10"
      - "traefik.http.middlewares.code-strip.stripprefix.prefixes=/code"
      - "traefik.http.middlewares.code-headers.headers.customrequestheaders.X-Forwarded-Prefix=/code"

  jupyter:
    image: jupyter/datascience-notebook:${JUPYTER_VERSION:-latest}
    container_name: jupyter
    restart: always
    user: root
    command: start-notebook.sh --ServerApp.base_url=/jupyter --ServerApp.token='' --ServerApp.password=''
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - GRANT_SUDO=yes
      - CHOWN_HOME=yes
      - CHOWN_HOME_OPTS=-R
      - NB_USER=${JUPYTER_USER:-jovyan}
      - NB_UID=${PUID:-1000}
      - NB_GID=${PGID:-1000}
      - RESTARTABLE=yes
    volumes:
      - ${JUPYTER_WORKSPACE_PATH:-./jupyter/workspace}:/home/jovyan/work
      - ${JUPYTER_CONFIG_PATH:-./jupyter/config}:/home/jovyan/.jupyter
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jupyter.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/jupyter`)"
      - "traefik.http.routers.jupyter.entrypoints=websecure"
      - "traefik.http.routers.jupyter.tls=true"
      - "traefik.http.services.jupyter.loadbalancer.server.port=8888"
      - "traefik.http.routers.jupyter.middlewares=auth"
      - "traefik.http.routers.jupyter.priority=10"

  postgres:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-devuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-devdb}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - dev_network

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - dev_network

  grafana:
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    container_name: grafana
    restart: always
    environment:
      - GF_AUTH_DISABLE_LOGIN_FORM=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_SERVER_ROOT_URL=https://${DOMAIN}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ${GRAFANA_PROVISIONING_PATH:-./grafana}:/etc/grafana/provisioning
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/grafana`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.http.routers.grafana.middlewares=auth"
      - "traefik.http.routers.grafana.priority=10"

  prometheus:
    image: prom/prometheus:${PROMETHEUS_VERSION:-latest}
    container_name: prometheus
    restart: always
    volumes:
      - ${PROMETHEUS_CONFIG_PATH:-./prometheus.yml}:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.external-url=https://${DOMAIN}/prometheus'
      - '--web.route-prefix=/'
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/prometheus`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
      - "traefik.http.routers.prometheus.middlewares=auth,prometheus-strip"
      - "traefik.http.routers.prometheus.priority=10"
      - "traefik.http.middlewares.prometheus-strip.stripprefix.prefixes=/prometheus"

  loki:
    image: grafana/loki:${LOKI_VERSION:-latest}
    container_name: loki
    restart: always
    volumes:
      - ${LOKI_CONFIG_PATH:-./loki-config.yml}:/etc/loki/config.yml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/config.yml
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loki.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/loki`)"
      - "traefik.http.routers.loki.entrypoints=websecure"
      - "traefik.http.routers.loki.tls=true"
      - "traefik.http.services.loki.loadbalancer.server.port=3100"
      - "traefik.http.routers.loki.middlewares=auth"
      - "traefik.http.routers.loki.priority=10"

  promtail:
    image: grafana/promtail:${PROMTAIL_VERSION:-latest}
    container_name: promtail
    restart: always
    volumes:
      - ${PROMTAIL_CONFIG_PATH:-./promtail-config.yml}:/etc/promtail/promtail-config.yml
      - ${TRAEFIK_LOGS_PATH:-./logs}:/var/log/traefik:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/promtail-config.yml
    networks:
      - dev_network

  node-exporter:
    image: prom/node-exporter:${NODE_EXPORTER_VERSION:-latest}
    container_name: node-exporter
    restart: always
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - dev_network

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:${CADVISOR_VERSION:-latest}
    container_name: cadvisor
    restart: always
    command:
      - '--docker_only=true'
      - '--housekeeping_interval=30s'
      - '--disable_metrics=disk,diskIO,percpu'
      - '--store_container_labels=false'
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk:/dev/disk:ro
    privileged: true
    devices:
      - /dev/kmsg
    networks:
      - dev_network

  homepage:
    image: nginx:${NGINX_VERSION:-alpine}
    container_name: homepage
    restart: always
    volumes:
      - ${HOMEPAGE_PATH:-./homepage}:/usr/share/nginx/html:ro
    networks:
      - dev_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=(Host(`${DOMAIN}`) || Host(`${TAILSCALE_DOMAIN}`)) && PathPrefix(`/`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.services.homepage.loadbalancer.server.port=80"
      - "traefik.http.routers.homepage.middlewares=auth"
      - "traefik.http.routers.homepage.priority=1"

  public-api:
    build: ${API_PATH:-./api}
    container_name: public-api
    restart: always
    user: root
    ports:
      - "127.0.0.1:10000:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CORS_ORIGINS=${API_CORS_ORIGINS:-http://localhost:3000,https://elimelt.com}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - AGENTS=${AGENTS:-5}
      - AGENT_MIN_SLEEP_SEC=${AGENT_MIN_SLEEP_SEC:-30}
      - AGENT_MAX_SLEEP_SEC=${AGENT_MAX_SLEEP_SEC:-120}
      - AGENT_WAKE_PROB=${AGENT_WAKE_PROB:-0.2}
      - AGENT_WAKE_COOLDOWN_SEC=${AGENT_WAKE_COOLDOWN_SEC:-45}
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-200}
      - REDIS_POOL_TIMEOUT_SEC=${REDIS_POOL_TIMEOUT_SEC:-5}
      - REDIS_DEBUG=${REDIS_DEBUG:-0}
      - REQUEST_DEBUG=${REQUEST_DEBUG:-0}
      - WS_DEBUG=${WS_DEBUG:-0}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - ENABLE_CHAT_DB=1
      - ENABLE_AGENT=${ENABLE_AGENT:-1}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-devuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-devdb}
    depends_on:
      - redis
      - postgres
    networks:
      - dev_network

volumes:
  portainer_data:
  postgres_data:
  redis_data:
  grafana_data:
  prometheus_data:
  loki_data:


networks:
  dev_network:
    driver: bridge
